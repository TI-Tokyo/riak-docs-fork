---
title: "Re: [Basho Riak] Fail To Update Document Repeatly With Cluster of 5	Nodes"
description: ""
project: community
lastmod: 2017-02-06T11:12:29-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg17924"
mailinglist_parent_id: "msg17923"
author_name: "John Daily"
project_section: "mailinglistitem"
sent_date: 2017-02-06T11:12:29-08:00
---


Originally I suspected the context which allows Riak to resolve conflicts was 
not present in your data, but I see it in your map structure. Thanks for 
supplying such a detailed description.

How fast is your turnaround time between an update and a fetch? Even if the 
cluster is healthy itâ€™s not impossible to see a timeout between nodes, which 
could result in a stale retrieval. Have you verified whether the stale data 
persists?

A single node cluster gives an advantage that youâ€™ll never see in a real 
cluster: a perfectly synchronized clock. It also reduces (but does not 
completely eliminate) the possibility of an internal timeout between processes.

-John

> On Feb 6, 2017, at 1:02 PM, my hue  wrote:
> 
> Dear Riak Team,
> 
> I and my team used riak as database for my production with an cluster 
> including 5 nodes. 
> While production run, we meet an critical bug that is sometimes fail to 
> update document. 
> I and my colleagues performed debug and detected an issue with the scenario 
> as follow: 
> 
> + fetch document 
> + change value of document 
> + update document
> 
> Repeat about 10 times and will meet fail. With the document is updated 
> continually, 
> sometimes will face update fail.
> 
> The first time, 5 nodes of cluster we used riak version 2.1.1. 
> After meet above bug, we upgraded to use riak version 2.2.0 and this issue 
> still occurs.
> 
> Via many time test, debug using Tcpdump at riak node :
> 
> tcpdump -A -ttt -i {interface} src host {host} and dst port {port} 
> 
> And together with the command: 
> 
> riak-admin status | grep "node\_puts\_map\| node\_puts\_map\_total\| 
> node\_puts\_total\| vnode\_map\_update\_total\| vnode\_puts\_total\"
> 
> we got that the riak server already get the update request. 
> However, do not know why riak backend fail to update document. 
> At the fail time, from riak server log everything is ok. 
> 
> Then we removed cluster and use a single riak server, and see that above bug 
> never happen.
> 
> For that reason, think that is only happen with cluster work. We took 
> research on basho riak document and our riak configure 
> seems that like suggestion from document. We totally blocked on this issue 
> and hope that can get support from you 
> so that can obtain a stable work from riak database for our production. 
> Thank you so much. Hope that can get your reply soon.
> 
> 
> \* The following is our riak node information : 
> 
> Riak version: 2.2.0
> OS : CentOS Linux release 7.2.1511
> Cpu : 4 core
> Memory : 4G 
> Riak configure : the attached file "riak.conf"
> 
> Note : 
> 
> - We mostly using default configure of riak configure except that we used 
> storage backend is multi 
> 
> storage\_backend = multi
> multi\_backend.bitcask\_mult.storage\_backend = bitcask
> multi\_backend.bitcask\_mult.bitcask.data\_root = /var/lib/riak/bitcask\_mult
> multi\_backend.default = bitcask\_mult
> 
> -----------------------------------------------------------------------------------------------------------------------------
> 
> - Bucket type created with the following command:
> 
> riak-admin bucket-type create dev\_restor 
> '{"props":{"backend":"bitcask\_mult","datatype":"map"}}'
> riak-admin bucket-type activate dev\_restor
> 
> -----------------------------------------------------------------------------------------------------------------------------
> 
> - Bucket Type Status :
> 
> >> riak-admin bucket-type status dev\_restor
> 
> dev\_restor is active
> young\_vclock: 20
> w: quorum
> small\_vclock: 50
> rw: quorum
> r: quorum
> pw: 0
> precommit: []
> pr: 0
> postcommit: []
> old\_vclock: 86400
> notfound\_ok: true
> n\_val: 3
> linkfun: {modfun,riak\_kv\_wm\_link\_walker,mapreduce\_linkfun}
> last\_write\_wins: false
> dw: quorum
> dvv\_enabled: true
> chash\_keyfun: {riak\_core\_util,chash\_std\_keyfun}
> big\_vclock: 50
> basic\_quorum: false
> backend: <<"bitcask\_mult">>
> allow\_mult: true
> datatype: map
> active: true
> claimant: 'riak-node1@64.137.190.244 '
> 
> -----------------------------------------------------------------------------------------------------------------------------
> 
> - Bucket Property :
> 
> {"props":{"name":"menu","active":true,"allow\_mult":true,"backend":"bitcask\_mult","basic\_quorum":false,"big\_vclock":50,"chash\_keyfun":{"mod":"riak\_core\_util","fun":"chash\_std\_keyfun"},"claimant":"riak-node1@64.137.190.244
> 
> ","datatype":"map","dvv\_enabled":true,"dw":"quorum","last\_write\_wins":false,"linkfun":{"mod":"riak\_kv\_wm\_link\_walker","fun":"mapreduce\_linkfun"},"n\_val":3,"name":"menu","notfound\_ok":true,"old\_vclock":86400,"postcommit":[],"pr":0,"precommit":[],"pw":0,"r":"quorum","rw":"quorum","search\_index":"menu\_idx","small\_vclock":50,"w":"quorum","young\_vclock":20}}
> 
> 
> -----------------------------------------------------------------------------------------------------------------------------
> 
> - Member status :
> 
> >> riak-admin member-status
> 
> ================================= Membership 
> ==================================
> Status Ring Pending Node
> -------------------------------------------------------------------------------
> valid 18.8% -- 'riak-node1@64.137.190.244 
> '
> valid 18.8% -- 'riak-node2@64.137.247.82 
> '
> valid 18.8% -- 'riak-node3@64.137.162.64 
> '
> valid 25.0% -- 'riak-node4@64.137.161.229 
> '
> valid 18.8% -- 'riak-node5@64.137.217.73 
> '
> -------------------------------------------------------------------------------
> Valid:5 / Leaving:0 / Exiting:0 / Joining:0 / Down:0
> 
> 
> -----------------------------------------------------------------------------------------------------------------------------
> 
> - Ring 
> 
> >> riak-admin status | grep ring
> 
> ring\_creation\_size : 64
> ring\_members : ['riak-node1@64.137.190.244 
> ','riak-node2@64.137.247.82 
> ', 'riak-node3@64.137.162.64 
> ','riak-node4@64.137.161.229 
> ', 'riak-node5@64.137.217.73 
> ']
> ring\_num\_partitions : 64
> ring\_ownership : <<"[{'riak-node2@64.137.247.82 
> ',12},\n {'riak-node5@64.137.217.73 
> ',12},\n {'riak-node1@64.137.190.244 
> ',12},\n {'riak-node3@64.137.162.64 
> ',12},\n {'riak-node4@64.137.161.229 
> ',16}]">>
> rings\_reconciled : 0
> rings\_reconciled\_total : 31
> 
> -----------------------------------------------------------------------------------------------------------------------------
> 
> \* The riak client :
> 
> + riak-erlang-client: https://github.com/basho/riak-erlang-client 
>  
> + release : 2.4.2 
> 
> -----------------------------------------------------------------------------------------------------------------------------
> 
> \* Riak client API used: 
> 
> + Insert/Update: 
> 
> riakc\_pb\_socket:update\_type(Pid, {Bucket-Type, Bucket}, Key, 
> riakc\_map:to\_op(Map), []).
> 
> + Fetch :
> 
> riakc\_pb\_socket:fetch\_type(Pid, {BucketType, Bucket}, Key, []). 
> 
> -----------------------------------------------------------------------------------------------------------------------------
> 
> \* Step to perform an update :
> 
> - Fetch document 
> - Update document 
> 
> -----------------------------------------------------------------------------------------------------------------------------
> 
> \* Data got from fetch\_type: 
> 
> {map, [{{<<"account\_id">>,register}, 
> <<"accounta25a424b8484181e8ba1bec25bf7c491">>},
> {{<<"created\_by\_id">>,register}, 
> <<"accounta25a424b8484181e8ba1bec25bf7c491">>}, 
> {{<<"created\_time\_dt">>,register},<<"2017-01-27T03:34:04Z">>}, 
> {{<<"currency">>,register},<<"cad">>}, 
> {{<<"end\_time">>,register},<<"dont\_use">>}, 
> {{<<"id">>,register},<<"menufe89488afa948875cab6b0b18d579f21">>}, 
> {{<<"maintain\_mode\_b">>,register},<<"false">>}, 
> {{<<"menu\_category\_revision\_id">>,register}, 
> <<"0-634736bc14e0bd3ed7e3fe0f1ee64443">>}, 
> {{<<"name">>,register},<<"fullmenu">>}, {{<<"order\_i">>,register},<<"0">>}, 
> {{<<"rest\_location\_p">>,register}, 
> <<"10.844117421366443,106.63982392275398">>}, 
> {{<<"restaurant\_id">>,register}, <<"rest848e042b3a0488640981c8a6dc4a8281">>}, 
> {{<<"restaurant\_status\_id">>,register},<<"inactive">>}, 
> {{<<"start\_time">>,register},<<"dont\_use">>}, 
> {{<<"status\_id">>,register},<<"hide">>}, {{<<"updated\_by\_id">>,register}, 
> <<"accounta25a424b8484181e8ba1bec25bf7c491">>}, 
> {{<<"updated\_time\_dt">>,register},<<"2017-02-06T17:22:39Z">>}],
> [],
> [], 
> <<131,108,0,0,0,3,104,2,109,0,0,0,12,39,21,84,209,219,42,57,233,0,0,156,252,97,34,104,2,109,0,0,0,12,132,107,248,226,103,5,182,208,0,0,118,2,97,40,104,2,109,0,0,0,12,137,252,139,186,176,202,25,96,0,0,195,164,97,54,106>>}
> 
> 
> \* Update with update\_type
> 
> Below is Map data before using riakc\_map:to\_op(Map) : 
> 
> {map, [] , 
> 
> [{{<<"account\_id">>,register},{register,<<>>,<<"accounta25a424b8484181e8ba1bec25bf7c491">>}},{{<<"created\_by\_id">>,register},{register,<<>>,<<"accounta25a424b8484181e8ba1bec25bf7c491">>}},{{<<"created\_time\_dt">>,register},{register,<<>>,<<"2017-01-27T03:34:04Z">>}},{{<<"currency">>,register},{register,<<>>,<<"cad">>}},{{<<"end\_time">>,register},{register,<<>>,<<"dont\_use">>}},{{<<"id">>,register},{register,<<>>,<<"menufe89488afa948875cab6b0b18d579f21">>}},{{<<"maintain\_mode\_b">>,register},{register,<<>>,<<"false">>}},{{<<"menu\_category\_revision\_id">>,register},{register,<<>>,<<"0-634736bc14e0bd3ed7e3fe0f1ee64443">>}},{{<<"name">>,register},{register,<<>>,<<"fullmenu">>}},{{<<"order\_i">>,register},{register,<<>>,<<"0">>}},{{<<"rest\_location\_p">>,register},{register,<<>>,<<"10.844117421366443,106.63982392275398">>}},{{<<"restaurant\_id">>,register},{register,<<>>,<<"rest848e042b3a0488640981c8a6dc4a8281">>}},{{<<"restaurant\_status\_id">>,register},{register,<<>>,<<"inactive">>}},{{<<"start\_time">>,register},{register,<<>>,<<"dont\_use">>}},{{<<"status\_id">>,register},{register,<<>>,<<"show">>}},{{<<"updated\_by\_id">>,register},{register,<<>>,<<"accounta25a424b8484181e8ba1bec25bf7c491">>}},{{<<"updated\_time\_dt">>,register},{register,<<>>,<<"2017-02-06T17:22:39Z">>}}],
> 
> [] , 
> <<131,108,0,0,0,3,104,2,109,0,0,0,12,39,21,84,209,219,42,57,233,0,0,156,252,97,34,104,2,109,0,0,0,12,132,107,248,226,103,5,182,208,0,0,118,2,97,39,104,2,109,0,0,0,12,137,252,139,186,176,202,25,96,0,0,195,164,97,53,106>>
> }
> 
> 
> 
> 
> - 
> 
> Best regards,
> Hue Tran
> \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
> riak-users mailing list
> riak-users@lists.basho.com
> http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

