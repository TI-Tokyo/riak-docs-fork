---
title: "Re: Upgrade from 1.3.1 to 1.4.2 => high IO"
description: ""
project: community
lastmod: 2013-12-11T04:35:16-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg13205"
mailinglist_parent_id: "msg13203"
author_name: "Matthew Von-Maszewski"
project_section: "mailinglistitem"
sent_date: 2013-12-11T04:35:16-08:00
---


Ok, I am now suspecting that your servers are either using swap space (which is 
slow) or your leveldb file cache is thrashing (opening and closing multiple 
files per request).

How many servers do you have and do you use Riak's active anti-entropy feature? 
 I am going to plug all of this into a spreadsheet. 

Matthew Von-Maszewski


On Dec 11, 2013, at 7:09, Simon Effenberg  wrote:

&gt; Hi Matthew
&gt; 
&gt; Memory: 23999 MB
&gt; 
&gt; ring\\_creation\\_size, 256
&gt; max\\_open\\_files, 100
&gt; 
&gt; riak-admin status:
&gt; 
&gt; memory\\_total : 276001360
&gt; memory\\_processes : 191506322
&gt; memory\\_processes\\_used : 191439568
&gt; memory\\_system : 84495038
&gt; memory\\_atom : 686993
&gt; memory\\_atom\\_used : 686560
&gt; memory\\_binary : 21965352
&gt; memory\\_code : 11332732
&gt; memory\\_ets : 10823528
&gt; 
&gt; Thanks for looking!
&gt; 
&gt; Cheers
&gt; Simon
&gt; 
&gt; 
&gt; 
&gt; On Wed, 11 Dec 2013 06:44:42 -0500
&gt; Matthew Von-Maszewski  wrote:
&gt; 
&gt;&gt; I need to ask other developers as they arrive for the new day. Does not 
&gt;&gt; make sense to me.
&gt;&gt; 
&gt;&gt; How many nodes do you have? How much RAM do you have in each node? What 
&gt;&gt; are your settings for max\\_open\\_files and cache\\_size in the app.config file? 
&gt;&gt; Maybe this is as simple as leveldb using too much RAM in 1.4. The memory 
&gt;&gt; accounting for maz\\_open\\_files changed in 1.4.
&gt;&gt; 
&gt;&gt; Matthew Von-Maszewski
&gt;&gt; 
&gt;&gt; 
&gt;&gt; On Dec 11, 2013, at 6:28, Simon Effenberg  wrote:
&gt;&gt; 
&gt;&gt;&gt; Hi Matthew,
&gt;&gt;&gt; 
&gt;&gt;&gt; it took around 11hours for the first node to finish the compaction. The
&gt;&gt;&gt; second node is running already 12 hours and is still doing compaction.
&gt;&gt;&gt; 
&gt;&gt;&gt; Besides that I wonder because the fsm\\_put time on the new 1.4.2 host is
&gt;&gt;&gt; much higher (after the compaction) than on an old 1.3.1 (both are
&gt;&gt;&gt; running in the cluster right now and another one is doing the
&gt;&gt;&gt; compaction/upgrade while it is in the cluster but not directly
&gt;&gt;&gt; accessible because it is out of the Loadbalancer):
&gt;&gt;&gt; 
&gt;&gt;&gt; 1.4.2:
&gt;&gt;&gt; 
&gt;&gt;&gt; node\\_put\\_fsm\\_time\\_mean : 2208050
&gt;&gt;&gt; node\\_put\\_fsm\\_time\\_median : 39231
&gt;&gt;&gt; node\\_put\\_fsm\\_time\\_95 : 17400382
&gt;&gt;&gt; node\\_put\\_fsm\\_time\\_99 : 50965752
&gt;&gt;&gt; node\\_put\\_fsm\\_time\\_100 : 59537762
&gt;&gt;&gt; node\\_put\\_fsm\\_active : 5
&gt;&gt;&gt; node\\_put\\_fsm\\_active\\_60s : 364
&gt;&gt;&gt; node\\_put\\_fsm\\_in\\_rate : 5
&gt;&gt;&gt; node\\_put\\_fsm\\_out\\_rate : 3
&gt;&gt;&gt; node\\_put\\_fsm\\_rejected : 0
&gt;&gt;&gt; node\\_put\\_fsm\\_rejected\\_60s : 0
&gt;&gt;&gt; node\\_put\\_fsm\\_rejected\\_total : 0
&gt;&gt;&gt; 
&gt;&gt;&gt; 
&gt;&gt;&gt; 1.3.1:
&gt;&gt;&gt; 
&gt;&gt;&gt; node\\_put\\_fsm\\_time\\_mean : 5036
&gt;&gt;&gt; node\\_put\\_fsm\\_time\\_median : 1614
&gt;&gt;&gt; node\\_put\\_fsm\\_time\\_95 : 8789
&gt;&gt;&gt; node\\_put\\_fsm\\_time\\_99 : 38258
&gt;&gt;&gt; node\\_put\\_fsm\\_time\\_100 : 384372
&gt;&gt;&gt; 
&gt;&gt;&gt; 
&gt;&gt;&gt; any clue why this could/should be?
&gt;&gt;&gt; 
&gt;&gt;&gt; Cheers
&gt;&gt;&gt; Simon
&gt;&gt;&gt; 
&gt;&gt;&gt; On Tue, 10 Dec 2013 17:21:07 +0100
&gt;&gt;&gt; Simon Effenberg  wrote:
&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; Hi Matthew,
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; thanks!.. that answers my questions!
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; Cheers
&gt;&gt;&gt;&gt; Simon
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; On Tue, 10 Dec 2013 11:08:32 -0500
&gt;&gt;&gt;&gt; Matthew Von-Maszewski  wrote:
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; 2i is not my expertise, so I had to discuss you concerns with another 
&gt;&gt;&gt;&gt;&gt; Basho developer. He says:
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; Between 1.3 and 1.4, the 2i query did change but not the 2i on-disk 
&gt;&gt;&gt;&gt;&gt; format. You must wait for all nodes to update if you desire to use the 
&gt;&gt;&gt;&gt;&gt; new 2i query. The 2i data will properly write/update on both 1.3 and 1.4 
&gt;&gt;&gt;&gt;&gt; machines during the migration.
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; Does that answer your question?
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; And yes, you might see available disk space increase during the upgrade 
&gt;&gt;&gt;&gt;&gt; compactions if your dataset contains numerous delete "tombstones". The 
&gt;&gt;&gt;&gt;&gt; Riak 2.0 code includes a new feature called "aggressive delete" for 
&gt;&gt;&gt;&gt;&gt; leveldb. This feature is more proactive in pushing delete tombstones 
&gt;&gt;&gt;&gt;&gt; through the levels to free up disk space much more quickly (especially if 
&gt;&gt;&gt;&gt;&gt; you perform block deletes every now and then).
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; Matthew
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; On Dec 10, 2013, at 10:44 AM, Simon Effenberg  
&gt;&gt;&gt;&gt;&gt; wrote:
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt; Hi Matthew,
&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt; see inline..
&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt; On Tue, 10 Dec 2013 10:38:03 -0500
&gt;&gt;&gt;&gt;&gt;&gt; Matthew Von-Maszewski  wrote:
&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt;&gt; The sad truth is that you are not the first to see this problem. And 
&gt;&gt;&gt;&gt;&gt;&gt;&gt; yes, it has to do with your 950GB per node dataset. And no, nothing to 
&gt;&gt;&gt;&gt;&gt;&gt;&gt; do but sit through it at this time.
&gt;&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt;&gt; While I did extensive testing around upgrade times before shipping 1.4, 
&gt;&gt;&gt;&gt;&gt;&gt;&gt; apparently there are data configurations I did not anticipate. You are 
&gt;&gt;&gt;&gt;&gt;&gt;&gt; likely seeing a cascade where a shift of one file from level-1 to 
&gt;&gt;&gt;&gt;&gt;&gt;&gt; level-2 is causing a shift of another file from level-2 to level-3, 
&gt;&gt;&gt;&gt;&gt;&gt;&gt; which causes a level-3 file to shift to level-4, etc … then the next 
&gt;&gt;&gt;&gt;&gt;&gt;&gt; file shifts from level-1.
&gt;&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt;&gt; The bright side of this pain is that you will end up with better write 
&gt;&gt;&gt;&gt;&gt;&gt;&gt; throughput once all the compaction ends.
&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt; I have to deal with that.. but my problem is now, if I'm doing this
&gt;&gt;&gt;&gt;&gt;&gt; node by node it looks like 2i searches aren't possible while 1.3 and
&gt;&gt;&gt;&gt;&gt;&gt; 1.4 nodes exists in the cluster. Is there any problem which leads me to
&gt;&gt;&gt;&gt;&gt;&gt; an 2i repair marathon or could I easily wait for some hours for each
&gt;&gt;&gt;&gt;&gt;&gt; node until all merges are done before I upgrade the next one? (2i
&gt;&gt;&gt;&gt;&gt;&gt; searches can fail for some time.. the APP isn't having problems with
&gt;&gt;&gt;&gt;&gt;&gt; that but are new inserts with 2i indices processed successfully or do
&gt;&gt;&gt;&gt;&gt;&gt; I have to do the 2i repair?)
&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt; /s
&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt; one other good think: saving disk space is one advantage ;)..
&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt;&gt; Riak 2.0's leveldb has code to prevent/reduce compaction cascades, but 
&gt;&gt;&gt;&gt;&gt;&gt;&gt; that is not going to help you today.
&gt;&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt;&gt; Matthew
&gt;&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt;&gt; On Dec 10, 2013, at 10:26 AM, Simon Effenberg 
&gt;&gt;&gt;&gt;&gt;&gt;&gt;  wrote:
&gt;&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; Hi @list,
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; I'm trying to upgrade our Riak cluster from 1.3.1 to 1.4.2 .. after
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; upgrading the first node (out of 12) this node seems to do many merges.
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; the sst\\_\\* directories changes in size "rapidly" and the node is having
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; a disk utilization of 100% all the time.
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; I know that there is something like that:
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; "The first execution of 1.4.0 leveldb using a 1.3.x or 1.2.x dataset
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; will initiate an automatic conversion that could pause the startup of
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; each node by 3 to 7 minutes. The leveldb data in "level #1" is being
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; adjusted such that "level #1" can operate as an overlapped data level
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; instead of as a sorted data level. The conversion is simply the
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; reduction of the number of files in "level #1" to being less than eight
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; via normal compaction of data from "level #1" into "level #2". This is
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; a one time conversion."
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; but it looks much more invasive than explained here or doesn't have to
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; do anything with the (probably seen) merges.
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; Is this "normal" behavior or could I do anything about it?
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; At the moment I'm stucked with the upgrade procedure because this high
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; IO load would probably lead to high response times.
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; Also we have a lot of data (per node ~950 GB).
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; Cheers
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; Simon
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; riak-users mailing list
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; riak-users@lists.basho.com
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt;&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt; -- 
&gt;&gt;&gt;&gt;&gt;&gt; Simon Effenberg | Site Ops Engineer | mobile.international GmbH
&gt;&gt;&gt;&gt;&gt;&gt; Fon: + 49-(0)30-8109 - 7173
&gt;&gt;&gt;&gt;&gt;&gt; Fax: + 49-(0)30-8109 - 7131
&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt; Mail: seffenb...@team.mobile.de
&gt;&gt;&gt;&gt;&gt;&gt; Web: www.mobile.de
&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt; Marktplatz 1 | 14532 Europarc Dreilinden | Germany
&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt; Geschäftsführer: Malte Krüger
&gt;&gt;&gt;&gt;&gt;&gt; HRB Nr.: 18517 P, Amtsgericht Potsdam
&gt;&gt;&gt;&gt;&gt;&gt; Sitz der Gesellschaft: Kleinmachnow 
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; -- 
&gt;&gt;&gt;&gt; Simon Effenberg | Site Ops Engineer | mobile.international GmbH
&gt;&gt;&gt;&gt; Fon: + 49-(0)30-8109 - 7173
&gt;&gt;&gt;&gt; Fax: + 49-(0)30-8109 - 7131
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; Mail: seffenb...@team.mobile.de
&gt;&gt;&gt;&gt; Web: www.mobile.de
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; Marktplatz 1 | 14532 Europarc Dreilinden | Germany
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; Geschäftsführer: Malte Krüger
&gt;&gt;&gt;&gt; HRB Nr.: 18517 P, Amtsgericht Potsdam
&gt;&gt;&gt;&gt; Sitz der Gesellschaft: Kleinmachnow 
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt;&gt;&gt;&gt; riak-users mailing list
&gt;&gt;&gt;&gt; riak-users@lists.basho.com
&gt;&gt;&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt;&gt;&gt; 
&gt;&gt;&gt; 
&gt;&gt;&gt; -- 
&gt;&gt;&gt; Simon Effenberg | Site Ops Engineer | mobile.international GmbH
&gt;&gt;&gt; Fon: + 49-(0)30-8109 - 7173
&gt;&gt;&gt; Fax: + 49-(0)30-8109 - 7131
&gt;&gt;&gt; 
&gt;&gt;&gt; Mail: seffenb...@team.mobile.de
&gt;&gt;&gt; Web: www.mobile.de
&gt;&gt;&gt; 
&gt;&gt;&gt; Marktplatz 1 | 14532 Europarc Dreilinden | Germany
&gt;&gt;&gt; 
&gt;&gt;&gt; 
&gt;&gt;&gt; Geschäftsführer: Malte Krüger
&gt;&gt;&gt; HRB Nr.: 18517 P, Amtsgericht Potsdam
&gt;&gt;&gt; Sitz der Gesellschaft: Kleinmachnow 
&gt; 
&gt; 
&gt; -- 
&gt; Simon Effenberg | Site Ops Engineer | mobile.international GmbH
&gt; Fon: + 49-(0)30-8109 - 7173
&gt; Fax: + 49-(0)30-8109 - 7131
&gt; 
&gt; Mail: seffenb...@team.mobile.de
&gt; Web: www.mobile.de
&gt; 
&gt; Marktplatz 1 | 14532 Europarc Dreilinden | Germany
&gt; 
&gt; 
&gt; Geschäftsführer: Malte Krüger
&gt; HRB Nr.: 18517 P, Amtsgericht Potsdam
&gt; Sitz der Gesellschaft: Kleinmachnow 

\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

