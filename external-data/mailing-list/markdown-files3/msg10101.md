---
title: "Re: ListKeys or MapReduce"
description: ""
project: community
lastmod: 2013-02-12T11:15:15-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg10101"
mailinglist_parent_id: "msg10100"
author_name: "Jeremiah Peschka"
project_section: "mailinglistitem"
sent_date: 2013-02-12T11:15:15-08:00
---


Good news! You've found a bug in CorrugatedIron. Because of index naming,
we muck index names to have a suffix of \_bin or \_int, depending on the
index type. This shouldn't be happening on $key, but it is. I'll create a
github issue and get that taken care of.

---
Jeremiah Peschka - Founder, Brent Ozar Unlimited
MCITP: SQL Server 2008, MVP
Cloudera Certified Developer for Apache Hadoop


On Tue, Feb 12, 2013 at 7:56 AM, Kevin Burton wrote:

> I forgot to mention that when I execute this code I get the error:\*\*\*\*
>
> \*\* \*\*
>
> {not\_found,\*\*\*\*
>
> {<<"products">>,\*\*\*\*
>
> <<"$keys">>},\*\*\*\*
>
> undefined}}}:[{mochijson2,\*\*\*\*
>
> json\_encode,2,\*\*\*\*
>
> [{file,\*\*\*\*
>
>
> "src/mochijson2.erl"},\*\*\*\*
>
> {line,149}]},\*\*\*\*
>
> {mochijson2,\*\*\*\*
>
>
> '-json\_encode\_array/2-fun-0-',\*\*\*\*
>
> 3,\*\*\*\*
>
> [{file,\*\*\*\*
>
>
> "src/mochijson2.erl"},\*\*\*\*
>
> {line,157}]},\*\*\*\*
>
> {lists,foldl,3,\*\*\*\*
>
>
> [{file,"lists.erl"},\*\*\*\*
>
> {line,1197}]},\*\*\*
> \*
>
> {mochijson2,\*\*\*\*
>
>
> json\_encode\_array,2,\*\*\*\*
>
> [{file,\*\*\*\*
>
>
> "src/mochijson2.erl"},\*\*\*\*
>
> {line,159}]},\*\*\*\*
>
> {riak\_kv\_pb\_mapred,
> \*\*\*\*
>
> process\_stream,3,\*
> \*\*\*
>
> [{file,\*\*\*\*
>
>
> "src/riak\_kv\_pb\_mapred.erl"},\*\*\*\*
>
> {line,97}]},\*\*\*\*
>
> {riak\_api\_pb\_server,
> \*\*\*\*
>
> process\_stream,5,\*
> \*\*\*
>
> [{file,\*\*\*\*
>
>
> "src/riak\_api\_pb\_server.erl"},\*\*\*\*
>
> {line,227}]},\*\*\*\*
>
> {riak\_api\_pb\_server,
> \*\*\*\*
>
> handle\_info,2,\*\*\*\*
>
> [{file,\*\*\*\*
>
>
> "src/riak\_api\_pb\_server.erl"},\*\*\*\*
>
> {line,158}]},\*\*\*\*
>
> {gen\_server,\*\*\*\*
>
> handle\_msg,5,\*\*\*\*
>
> [{file,\*\*\*\*
>
>
> "gen\_server.erl"},\*\*\*\*
>
> {line,607}]}] -
> CommunicationError\*\*\*\*
>
> \*\* \*\*
>
> \*\* \*\*
>
> \*From:\* riak-users [mailto:riak-users-boun...@lists.basho.com] \*On Behalf
> Of \*Kevin Burton
> \*Sent:\* Tuesday, February 12, 2013 9:48 AM
> \*To:\* 'Jeremiah Peschka'
> \*Cc:\* 'riak-users'
> \*Subject:\* RE: ListKeys or MapReduce\*\*\*\*
>
> \*\* \*\*
>
> The name is â€œ$keysâ€? Something like:\*\*\*\*
>
> \*\* \*\*
>
> using (IRiakEndPoint cluster = RiakCluster.FromConfig(
> "riakConfig"))\*\*\*\*
>
> {\*\*\*\*
>
> IRiakClient riakClient = cluster.CreateClient();\*\*\*\*
>
> RiakBucketKeyInput bucketKeyInput = new RiakBucketKeyInput
> ();\*\*\*\*
>
> bucketKeyInput.AddBucketKey(productBucketName, "$keys");\*\*
> \*\*
>
> RiakMapReduceQuery query = new RiakMapReduceQuery()\*\*\*\*
>
> .Inputs(bucketKeyInput)\*\*\*\*
>
> .MapJs(m => m.Name("Riak.mapValuesJson").Keep(true));\*\*
> \*\*
>
> RiakResult result =
> riakClient.MapReduce(query);\*\*\*\*
>
> if (result.IsSuccess)\*\*\*\*
>
> {\*\*\*\*
>
> \*\* \*\*
>
> \*\* \*\*
>
> \*From:\* Jeremiah Peschka 
> [mailto:jeremiah.pesc...@gmail.com]
>
> \*Sent:\* Tuesday, February 12, 2013 9:18 AM
> \*To:\* Kevin Burton
> \*Cc:\* riak-users
> \*Subject:\* Re: ListKeys or MapReduce\*\*\*\*
>
> \*\* \*\*
>
> It would be queried like any other index as an MR input. I'll create an
> issue and will try to get this in some time in the next few days - no
> promises, though.\*\*\*\*
>
>
> \*\*\*\*
>
> ---\*\*\*\*
>
> Jeremiah Peschka - Founder, Brent Ozar Unlimited\*\*\*\*
>
> MCITP: SQL Server 2008, MVP\*\*\*\*
>
> Cloudera Certified Developer for Apache Hadoop\*\*\*\*
>
> \*\* \*\*
>
> On Tue, Feb 12, 2013 at 7:09 AM, Kevin Burton 
> wrote:\*\*\*\*
>
> I will read the other URLs that you mentioned. Thank you.\*\*\*\*
>
> \*\*\*\*
>
> Would you mind giving a short example (preferably using CI) of the $keys
> index?\*\*\*\*
>
> \*\*\*\*
>
> \*From:\* Jeremiah Peschka [mailto:jeremiah.pesc...@gmail.com]
> \*Sent:\* Tuesday, February 12, 2013 8:52 AM
> \*To:\* Kevin Burton
> \*Cc:\* riak-users
> \*Subject:\* Re: ListKeys or MapReduce\*\*\*\*
>
> \*\*\*\*
>
> They're both pretty crappy in terms of performance - they read all data
> off of disk. If you're using LevelDB you can use the $keys index to pull
> back just the keys that in a single bucket.\*\*\*\*
>
> \*\*\*\*
>
> A better approach is to maintain a separate bucket - e.g. DocumentCount -
> that is used for counting documents. Unfortunately, you can't guarantee
> transactional consistency around counts in Riak today, so you'll want to
> move maintaining the counts out of Riak and into something else. If you
> search the list archives [1], you'll find that Redis has been mentioned as
> a good way to solve this problem - counters are stored in Redis and flushed
> to Riak on a regular schedule. Because of the lack of consistency
> (especially around MapReduce operations), Riak isn't the best choice if you
> require counters/aggregations to be stored in the database.\*\*\*\*
>
> \*\*\*\*
>
> Once CRDTs [2] make it into mainstream Riak, you can make use of those
> data structures to implement distributed counters in Riak.\*\*\*\*
>
> \*\*\*\*
>
> [1]: http://riak.markmail.org\*\*\*\*
>
> [2]: http://vimeo.com/52414903\*\*\*\*
>
>
> \*\*\*\*
>
> ---\*\*\*\*
>
> Jeremiah Peschka - Founder, Brent Ozar Unlimited\*\*\*\*
>
> MCITP: SQL Server 2008, MVP\*\*\*\*
>
> Cloudera Certified Developer for Apache Hadoop\*\*\*\*
>
> \*\*\*\*
>
> On Mon, Feb 11, 2013 at 10:30 AM,  wrote:\*\*\*\*
>
> Say I need to determine how many document there are in my database. For a
> CorrugatedIron application I can do ListKeys and get the warning that it is
> an expensive operation or I can do a MapReduce query. Which is the the
> least expensive? Is there an option that I am missing?\*\*\*\*
>
>
> \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
> riak-users mailing list
> riak-users@lists.basho.com
> http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com\*\*\*\*
>
> \*\*\*\*
>
> \*\* \*\*
>
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

